<script>
  // ---------- CONFIG ----------
  const apiUrl = "https://script.google.com/macros/s/AKfycbwwzCiQTUppQN7xsuFnsEWE46kZD4vVMuHrOqIIZQEW0dESsXmiqcPeVliYDrjsuB3BdQ/exec";
  const API_KEY = "2f9a0d8b1e7c4f1b98d2a6e4c5f0b7a8d1e9f3c6a2b8e7f9d0c1a5b4e6d2f0a9"; // must match Script Properties

  // ---------- DOM ----------
  const wrapper       = document.getElementById("scratchWrapper");
  const prizeCanvas   = document.getElementById("prizeCanvas");
  const prizeCtx      = prizeCanvas.getContext("2d");
  const scratchCanvas = document.getElementById("scratchCanvas");
  const scratchCtx    = scratchCanvas.getContext("2d");
  const confettiEl    = document.getElementById("confetti");
  const copyRow       = document.getElementById("copyRow");
  const copyBtn       = document.getElementById("copyBtn");

  // ---------- Helpers ----------
  function drawCenteredText(ctx, text, bold=false) {
    ctx.clearRect(0,0,ctx.canvas.width, ctx.canvas.height);
    ctx.font = `${bold ? '700' : '400'} 18px Arial, sans-serif`;
    ctx.fillStyle = "#fff";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(text, ctx.canvas.width/2, ctx.canvas.height/2);
  }
  function fireConfetti() {
    confettiEl.innerHTML = "";
    const colors = ["#ffd76b", "#7a86ff", "#ff8ba7", "#7fffd4", "#ffffff"];
    for (let i=0;i<70;i++){
      const s = document.createElement("span");
      s.style.left = Math.random()*100 + "%";
      s.style.top  = "-10px";
      s.style.background = colors[Math.floor(Math.random()*colors.length)];
      s.style.animationDelay = (Math.random()*0.25) + "s";
      s.style.transform = `rotate(${Math.random()*360}deg)`;
      confettiEl.appendChild(s);
    }
    setTimeout(()=>confettiEl.innerHTML="",1300);
  }
  function celebrate() {
    wrapper.classList.remove("win-glow"); void wrapper.offsetWidth;
    wrapper.classList.add("win-glow");
    fireConfetti();
    copyRow.style.display = "block";
  }

  // ---------- Spinner on prize canvas (visible now) ----------
  let spinRAF = null, spinStart = null;
  function renderSpinner(ts) {
    if (!spinStart) spinStart = ts;
    const t = (ts - spinStart) / 1000, angle = t * 4 * Math.PI, radius = 14, stroke = 4;
    prizeCtx.clearRect(0,0,prizeCanvas.width,prizeCanvas.height);
    prizeCtx.save(); prizeCtx.translate(prizeCanvas.width/2, prizeCanvas.height/2); prizeCtx.rotate(angle);
    prizeCtx.beginPath(); prizeCtx.lineWidth = stroke; prizeCtx.lineCap = "round"; prizeCtx.strokeStyle = "#ffffff";
    prizeCtx.arc(0, 0, radius, 0, Math.PI * 1.6); prizeCtx.stroke(); prizeCtx.restore();
    spinRAF = requestAnimationFrame(renderSpinner);
  }
  function startSpinner(){ stopSpinner(); spinStart=null; spinRAF=requestAnimationFrame(renderSpinner); }
  function stopSpinner(){ if(spinRAF) cancelAnimationFrame(spinRAF); spinRAF=null; prizeCtx.clearRect(0,0,prizeCanvas.width,prizeCanvas.height); }

  // ---------- Scratch layer (paint AFTER we have a message) ----------
  const BRUSH = 50;
  let isDrawing=false, userScratched=false, apiReady=false, isWinner=false, winnerCode="";

  function enableScratchLayer() {
    // Paint the gray cover now and switch to erase mode
    scratchCtx.globalCompositeOperation = "source-over";
    scratchCtx.fillStyle = "#999";
    scratchCtx.clearRect(0,0,scratchCanvas.width, scratchCanvas.height);
    scratchCtx.fillRect(0,0,scratchCanvas.width, scratchCanvas.height);
    scratchCtx.globalCompositeOperation = "destination-out";

    // Pointer handlers
    function scratchAt(x,y){ scratchCtx.beginPath(); scratchCtx.arc(x,y,BRUSH,0,Math.PI*2); scratchCtx.fill(); }
    function startOnce(){
      if (!userScratched) {
        userScratched = true;
        wrapper.classList.remove("active-glow"); void wrapper.offsetWidth; wrapper.classList.add("active-glow");
        if (apiReady && isWinner) celebrate();
      }
    }
    // Mouse
    scratchCanvas.addEventListener("mousedown",(e)=>{ isDrawing=true; startOnce(); const r=scratchCanvas.getBoundingClientRect(); scratchAt(e.clientX-r.left,e.clientY-r.top); });
    scratchCanvas.addEventListener("mouseup",()=>isDrawing=false);
    scratchCanvas.addEventListener("mouseleave",()=>isDrawing=false);
    scratchCanvas.addEventListener("mousemove",(e)=>{ if(!isDrawing) return; const r=scratchCanvas.getBoundingClientRect(); scratchAt(e.clientX-r.left,e.clientY-r.top); });
    // Touch
    scratchCanvas.addEventListener("touchstart",(e)=>{ e.preventDefault(); isDrawing=true; startOnce(); const r=scratchCanvas.getBoundingClientRect(); const t=e.touches[0]; scratchAt(t.clientX-r.left,t.clientY-r.top); }, {passive:false});
    scratchCanvas.addEventListener("touchend",()=>{ isDrawing=false; }, {passive:true});
    scratchCanvas.addEventListener("touchmove",(e)=>{ e.preventDefault(); if(!isDrawing) return; const r=scratchCanvas.getBoundingClientRect(); const t=e.touches[0]; scratchAt(t.clientX-r.left,t.clientY-r.top); }, {passive:false});
  }

  // Copy handler
  copyBtn.addEventListener("click", ()=>{ if(!winnerCode) return; navigator.clipboard.writeText(winnerCode).then(()=>{ copyBtn.textContent="Copied!"; setTimeout(()=>copyBtn.textContent="Copy Code",1500); }).catch(()=>{ copyBtn.textContent="Copy failed"; setTimeout(()=>copyBtn.textContent="Copy Code",1500); }); });

  // ---------- Boot ----------
  // Show spinner visibly (no gray cover yet)
  startSpinner();

  const params = new URLSearchParams(location.search);
  const token  = (params.get('token') || '').trim();

  if (!token) {
    stopSpinner();
    drawCenteredText(prizeCtx, "‚ö†Ô∏è Invalid link.", false);
  } else {
    // Simple CORS request (no preflight): text/plain + apiKey in body
    fetch(apiUrl, {
      method: "POST",
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({ mode: "draw", token, apiKey: API_KEY })
    })
    .then(async r => {
      const ct = r.headers.get("content-type") || "";
      const data = ct.includes("application/json") ? await r.json() : { ok:false, error: await r.text() };
      stopSpinner();

      if (data.ok && data.status === 'ok' && data.mode === 'draw') {
        isWinner   = !!data.isWinner;
        winnerCode = data.code;
        drawCenteredText(prizeCtx, isWinner ? `üéâ You WON! Code: ${winnerCode}` : "üôÅ Better luck next time!", isWinner);
        apiReady = true;
        // Now that the message is drawn, enable the scratch layer so it hides it
        enableScratchLayer();
      } else if (data.status === 'token_used') {
        drawCenteredText(prizeCtx, "‚ö†Ô∏è This link was already used.", false);
        enableScratchLayer();
      } else if (data.status === 'token_expired') {
        drawCenteredText(prizeCtx, "‚ö†Ô∏è This link has expired.", false);
        enableScratchLayer();
      } else if (data.status === 'empty') {
        drawCenteredText(prizeCtx, "‚ö†Ô∏è No codes available.", false);
      } else if (data.status === 'token_invalid' || data.status === 'token_missing') {
        drawCenteredText(prizeCtx, "‚ö†Ô∏è Invalid link.", false);
      } else {
        drawCenteredText(prizeCtx, "‚ö†Ô∏è Error fetching code.", false);
        console.error("API error:", data);
      }
    })
    .catch(err => {
      stopSpinner();
      drawCenteredText(prizeCtx, "‚ö†Ô∏è Network error.", false);
      console.error("Fetch error:", err);
    });
  }
</script>

