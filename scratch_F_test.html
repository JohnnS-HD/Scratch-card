<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Scratch & Win</title>
  <style>
    :root { --bg:#171e31; --card:#1f2643; --ink:#fff; --muted:#ccc; --btn:#494f66; --focus:#7a86ff; }
    * { box-sizing: border-box; }
    body { background-color: var(--bg); font-family: Arial, sans-serif; text-align: center; color: var(--ink); margin: 0; padding: 0 12px 40px; overflow-x: hidden; }
    .logo { margin-top: 40px; margin-bottom: 20px; display: inline-block; }
    .container { background-color: var(--card); padding: 30px; margin: 0 auto 20px; max-width: 420px; border-radius: 12px; box-shadow: 0 10px 24px rgba(0,0,0,0.35); animation: fadeInUp 420ms ease both; }
    @keyframes fadeInUp { from {opacity:0; transform:translateY(8px);} to {opacity:1; transform:translateY(0);} }
    h2 { margin: 0 0 12px; font-weight: 700; letter-spacing: 0.2px; }
    .scratch-wrapper { position: relative; width: 360px; height: 100px; margin: 20px auto 0; border: 2px dashed #444; background-color: var(--card); border-radius: 10px; overflow: hidden; transition: box-shadow 300ms ease, transform 300ms ease; }
    .active-glow { animation: activePulse 900ms ease-out 1; }
    @keyframes activePulse { 0% { box-shadow: 0 0 0 0 rgba(255,255,255,0.0); } 40%{ box-shadow: 0 0 18px 6px rgba(255,255,255,0.15); } 100%{ box-shadow: 0 0 0 0 rgba(255,255,255,0); } }
    .win-glow { animation: winPulse 1200ms ease-out 2; }
    @keyframes winPulse { 0% { box-shadow: 0 0 0 0 rgba(255,215,107,0.6); transform: translateY(0) scale(1); } 40%{ box-shadow: 0 0 25px 8px rgba(255,215,107,0.5); transform: translateY(-2px) scale(1.02); } 100%{ box-shadow: 0 0 0 0 rgba(255,215,107,0); transform: translateY(0) scale(1); } }
    canvas { position: absolute; top: 0; left: 0; display:block; }
    #prizeCanvas { z-index: 1; } #scratchCanvas { z-index: 2; cursor: crosshair; }
    #copyRow { display:none; margin:10px auto 0; max-width:420px; }
    .btn { margin: 10px; padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; background: var(--btn); color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.25); transform: translateZ(0); transition: transform 160ms ease, box-shadow 160ms ease, filter 160ms ease; }
    .btn:hover { transform: translateY(-2px) scale(1.03); box-shadow: 0 8px 18px rgba(0,0,0,0.35); filter: brightness(1.05); }
    .btn-small { padding: 6px 12px; font-size: 14px; }
    .instructions-box { background-color: #192036; text-align: left; padding: 15px; margin-top: 30px; font-size: 14px; line-height: 1.4; color: var(--muted); border-radius: 8px; }
    .instructions-box a { color: var(--muted); text-decoration: underline; }
    .socials-wrap { margin:22px auto 0; max-width:560px; }
    .socials { display:flex; justify-content:center; gap:24px; flex-wrap:wrap; }
    .socials a img { width:60px; height:auto; object-fit:contain; display:block; }
    .socials a img[src*="discord"] { transform: scale(1.25); }
    @media (prefers-reduced-motion: reduce) { .btn { transition: none; } .active-glow, .win-glow { animation: none; } }
    .confetti { position:absolute; inset:0; pointer-events:none; z-index:3; }
    .confetti span { position:absolute; width:6px; height:10px; opacity:.9; animation:drop 900ms ease-out forwards; }
    @keyframes drop { 0%{transform:translateY(-20px) rotate(0)} 100%{transform:translateY(140px) rotate(360deg);opacity:0} }
  </style>
</head>
<body>
  <a href="https://www.hypedrop.com/" target="_blank" rel="noopener">
    <img src="Logo-Full-White.png" alt="Logo" class="logo" width="360"/>
  </a>

  <div class="container">
    <h2>Scratch here and get your prize</h2>

    <div class="scratch-wrapper" id="scratchWrapper">
      <canvas id="prizeCanvas" width="360" height="100"></canvas>
      <canvas id="scratchCanvas" width="360" height="100"></canvas>
      <div class="confetti" id="confetti"></div>
    </div>

    <div id="copyRow">
      <button id="copyBtn" class="btn btn-small" type="button">Copy Code</button>
    </div>

    <div class="instructions-box">
      <strong>How to redeem:</strong><br>
      Visit the Rewards page<br>
      Enter your code in ‚ÄúDo you have a promo code?‚Äù<br>
      Click Apply<br>
      Need help? <a href="https://www.hypedrop.com/support" target="_blank" rel="noopener">Support team</a> is ready to help you!
    </div>

    <div style="margin-top: 20px;">
      <button class="btn" onclick="window.location.href='https://www.hypedrop.com/na/rewards'">Go to Rewards</button>
    </div>
  </div>

  <div class="socials-wrap">
    <div class="socials">
      <a href="https://discord.gg/yGrM3eCsqD" target="_blank" rel="noopener"><img src="Discord.png" alt="Discord"/></a>
      <a href="https://www.instagram.com/hypedropcom/" target="_blank" rel="noopener"><img src="instagram-new--v2.png" alt="Instagram"/></a>
      <a href="https://x.com/HypeDrop" target="_blank" rel="noopener"><img src="X_logo_2023_(white).png" alt="X"/></a>
    </div>
  </div>

  <script>
    // ---------- CONFIG ----------
    <script>
  // ‚Ä¶ keep your existing code above ‚Ä¶

  const apiUrl = "https://script.google.com/macros/s/AKfycbwwzCiQTUppQN7xsuFnsEWE46kZD4vVMuHrOqIIZQEW0dESsXmiqcPeVliYDrjsuB3BdQ/exec";
  const API_KEY = "2f9a0d8b1e7c4f1b98d2a6e4c5f0b7a8d1e9f3c6a2b8e7f9d0c1a5b4e6d2f0a9"; // same as Script Properties

  // ‚Ä¶ keep spinner + scratch code ‚Ä¶

  const params = new URLSearchParams(location.search);
  const token  = (params.get('token') || '').trim();

  if (!token) {
    stopSpinner();
    drawCenteredText(prizeCtx, "‚ö†Ô∏è Invalid link.", false);
  } else {
    fetch(apiUrl, {
      method: "POST",
      // SIMPLE request: no custom headers, text/plain avoids preflight
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({ mode: "draw", token, apiKey: API_KEY })
    })
    .then(async r => {
      // If GAS throws HTML error, try to read text for debugging
      const ct = r.headers.get("content-type") || "";
      if (!ct.includes("application/json")) {
        const txt = await r.text();
        throw new Error("Non-JSON response: " + txt.slice(0, 200));
      }
      return r.json();
    })
    .then(data => {
      stopSpinner();
      if (data.status === 'ok' && data.mode === 'draw') {
        isWinner = !!data.isWinner;
        winnerCode = data.code;
        drawCenteredText(prizeCtx, isWinner ? `üéâ You WON! Code: ${winnerCode}` : "üôÅ Better luck next time!", isWinner);
        apiReady = true;
        if (userScratched && isWinner) celebrate();
      } else if (data.status === 'token_used') {
        drawCenteredText(prizeCtx, "‚ö†Ô∏è This link was already used.", false); apiReady = true;
      } else if (data.status === 'token_expired') {
        drawCenteredText(prizeCtx, "‚ö†Ô∏è This link has expired.", false); apiReady = true;
      } else if (data.status === 'empty') {
        drawCenteredText(prizeCtx, "‚ö†Ô∏è No codes available.", false); apiReady = true;
      } else if (data.status === 'token_invalid' || data.status === 'token_missing') {
        drawCenteredText(prizeCtx, "‚ö†Ô∏è Invalid link.", false); apiReady = true;
      } else {
        drawCenteredText(prizeCtx, "‚ö†Ô∏è Error fetching code.", false); apiReady = true;
      }
    })
    .catch(err => {
      stopSpinner();
      // Write a tiny hint to the canvas for quick debugging
      drawCenteredText(prizeCtx, "‚ö†Ô∏è Network error. (CORS/preflight)", false);
      console.error("Redeem request failed:", err);
      apiReady = true;
    });
  }
 </script>
</body>
</html>
