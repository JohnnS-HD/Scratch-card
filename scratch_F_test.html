<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Scratch & Win</title>

  <!-- Speed hints -->
  <link rel="preconnect" href="https://script.google.com">
  <link rel="dns-prefetch" href="https://script.google.com">

  <style>
    :root { --bg:#171e31; --card:#1f2643; --ink:#fff; --muted:#ccc; --btn:#494f66; --focus:#7a86ff; }
    * { box-sizing: border-box; }
    body { background-color: var(--bg); font-family: Arial, sans-serif; text-align: center; color: var(--ink); margin: 0; padding: 0 12px 40px; overflow-x: hidden; }
    .logo { margin-top: 40px; margin-bottom: 20px; display: inline-block; }

    .container {
      background-color: var(--card);
      padding: 30px;
      margin: 0 auto 20px;
      max-width: 420px;
      border-radius: 12px;
      box-shadow: 0 10px 24px rgba(0,0,0,0.35);
      animation: fadeInUp 420ms ease both;
    }
    @keyframes fadeInUp { from {opacity:0; transform:translateY(8px);} to {opacity:1; transform:translateY(0);} }

    h2 { margin: 0 0 12px; font-weight: 700; letter-spacing: 0.2px; }

    .scratch-wrapper {
      position: relative;
      width: 360px;
      height: 100px;
      margin: 20px auto 0;
      border: 2px dashed #444;
      background-color: var(--card);
      border-radius: 10px;
      overflow: hidden;
      transition: box-shadow 300ms ease, transform 300ms ease;
    }

    /* glow on first scratch (visual only) */
    .active-glow { animation: activePulse 900ms ease-out 1; }
    @keyframes activePulse {
      0% { box-shadow: 0 0 0 0 rgba(255,255,255,0.0); }
      40%{ box-shadow: 0 0 18px 6px rgba(255,255,255,0.15); }
      100%{ box-shadow: 0 0 0 0 rgba(255,255,255,0); }
    }
    /* win pulse (visual only) */
    .win-glow { animation: winPulse 1200ms ease-out 2; }
    @keyframes winPulse {
      0% { box-shadow: 0 0 0 0 rgba(255,215,107,0.6); transform: translateY(0) scale(1); }
      40%{ box-shadow: 0 0 25px 8px rgba(255,215,107,0.5); transform: translateY(-2px) scale(1.02); }
      100%{ box-shadow: 0 0 0 0 rgba(255,215,107,0); transform: translateY(0) scale(1); }
    }

    /* canvases */
    canvas { position: absolute; top: 0; left: 0; display:block; }
    #prizeCanvas { z-index: 1; }
    #scratchCanvas { z-index: 2; cursor: crosshair; }

    /* Copy row */
    #copyRow { display:none; margin:10px auto 0; max-width:420px; }
    .btn {
      margin: 10px; padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;
      background: var(--btn); color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.25); transform: translateZ(0);
      transition: transform 160ms ease, box-shadow 160ms ease, filter 160ms ease;
    }
    .btn:hover { transform: translateY(-2px) scale(1.03); box-shadow: 0 8px 18px rgba(0,0,0,0.35); filter: brightness(1.05); }
    .btn-small { padding: 6px 12px; font-size: 14px; }

    .instructions-box {
      background-color: #192036; text-align: left; padding: 15px; margin-top: 30px; font-size: 14px; line-height: 1.4; color: var(--muted); border-radius: 8px;
    }
    .instructions-box a { color: var(--muted); text-decoration: underline; }

    /* Socials */
    .socials-wrap { margin:22px auto 0; max-width:560px; }
    .socials { display:flex; justify-content:center; gap:24px; flex-wrap:wrap; }
    .socials a img { width:60px; height:auto; object-fit:contain; display:block; }
    .socials a img[src*="discord"] { transform: scale(1.25); }

    @media (prefers-reduced-motion: reduce) {
      .btn { transition: none; }
      .active-glow, .win-glow { animation: none; }
    }

    /* confetti layer (visual only) */
    .confetti { position:absolute; inset:0; pointer-events:none; z-index:3; }
    .confetti span { position:absolute; width:6px; height:10px; opacity:.9; animation:drop 900ms ease-out forwards; }
    @keyframes drop { 0%{transform:translateY(-20px) rotate(0)} 100%{transform:translateY(140px) rotate(360deg);opacity:0} }
  </style>
</head>

<body>
  <a href="https://www.hypedrop.com/" target="_blank" rel="noopener">
    <img src="Logo-Full-White.png" alt="Logo" class="logo" width="360"/>
  </a>

  <div class="container">
    <h2>Scratch here and get your prize</h2>

    <div class="scratch-wrapper" id="scratchWrapper">
      <canvas id="prizeCanvas" width="360" height="100" aria-hidden="true"></canvas>
      <canvas id="scratchCanvas" width="360" height="100"></canvas>
      <div class="confetti" id="confetti"></div>
    </div>

    <div id="copyRow">
      <button id="copyBtn" class="btn btn-small" type="button">Copy Code</button>
    </div>

    <div class="instructions-box">
      <strong>How to redeem:</strong><br>
      Visit the Rewards page<br>
      Enter your code in ‚ÄúDo you have a promo code?‚Äù<br>
      Click Apply<br>
      Need help? <a href="https://www.hypedrop.com/support" target="_blank" rel="noopener">Support team</a> is ready to help you!
    </div>

    <div style="margin-top: 20px;">
      <button class="btn" onclick="window.location.href='https://www.hypedrop.com/na/rewards'">Go to Rewards</button>
    </div>
  </div>

  <div class="socials-wrap">
    <div class="socials">
      <a href="https://discord.gg/yGrM3eCsqD" target="_blank" rel="noopener"><img src="Discord.png" alt="Discord"/></a>
      <a href="https://www.instagram.com/hypedropcom/" target="_blank" rel="noopener"><img src="instagram-new--v2.png" alt="Instagram"/></a>
      <a href="https://x.com/HypeDrop" target="_blank" rel="noopener"><img src="X_logo_2023_(white).png" alt="X"/></a>
    </div>
  </div>

  <script>
    // ---------- CONFIG ----------
    const apiUrl = "https://script.google.com/macros/s/AKfycbwwzCiQTUppQN7xsuFnsEWE46kZD4vVMuHrOqIIZQEW0dESsXmiqcPeVliYDrjsuB3BdQ/exec";
    const API_KEY = "2f9a0d8b1e7c4f1b98d2a6e4c5f0b7a8d1e9f3c6a2b8e7f9d0c1a5b4e6d2f0a9";

    // ---------- DOM ----------
    const wrapper       = document.getElementById("scratchWrapper");
    const prizeCanvas   = document.getElementById("prizeCanvas");
    const prizeCtx      = prizeCanvas.getContext("2d");
    const scratchCanvas = document.getElementById("scratchCanvas");
    const scratchCtx    = scratchCanvas.getContext("2d");
    const confettiEl    = document.getElementById("confetti");
    const copyRow       = document.getElementById("copyRow");
    const copyBtn       = document.getElementById("copyBtn");

    // ---------- HiDPI / Retina scaling ----------
    function scaleCanvasForDPR(canvas, ctx) {
      const dpr = window.devicePixelRatio || 1;
      const cssW = canvas.clientWidth || canvas.width;
      const cssH = canvas.clientHeight || canvas.height;
      canvas.width  = Math.round(cssW * dpr);
      canvas.height = Math.round(cssH * dpr);
      canvas.style.width  = cssW + "px";
      canvas.style.height = cssH + "px";
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }
    scaleCanvasForDPR(prizeCanvas, prizeCtx);
    scaleCanvasForDPR(scratchCanvas, scratchCtx);
    window.addEventListener('resize', () => {
      scaleCanvasForDPR(prizeCanvas, prizeCtx);
      scaleCanvasForDPR(scratchCanvas, scratchCtx);
    });

    // ---------- Helpers ----------
    function drawCenteredText(ctx, text, bold=false) {
      ctx.clearRect(0,0,ctx.canvas.width, ctx.canvas.height);
      ctx.font = `${bold ? '700' : '400'} 18px Arial, sans-serif`;
      ctx.fillStyle = "#fff";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(text, ctx.canvas.width/2, ctx.canvas.height/2);
    }
    function fireConfetti() {
      confettiEl.innerHTML = "";
      const colors = ["#ffd76b", "#7a86ff", "#ff8ba7", "#7fffd4", "#ffffff"];
      for (let i=0;i<70;i++){
        const s = document.createElement("span");
        s.style.left = Math.random()*100 + "%";
        s.style.top  = "-10px";
        s.style.background = colors[Math.floor(Math.random()*colors.length)];
        s.style.animationDelay = (Math.random()*0.25) + "s";
        confettiEl.appendChild(s);
      }
      setTimeout(()=>confettiEl.innerHTML="",1300);
    }
    function celebrate() {
      wrapper.classList.remove("win-glow");
      void wrapper.offsetWidth;
      wrapper.classList.add("win-glow");
      fireConfetti();
      copyRow.style.display = "block";
    }

    // ---------- Spinner ----------
    let spinRAF = null, spinStart = null;
    function renderSpinner(ts) {
      if (!spinStart) spinStart = ts;
      const t = (ts - spinStart) / 1000;
      const angle = t * 4 * Math.PI;
      const radius = 14;
      const stroke = 4;
      prizeCtx.clearRect(0,0,prizeCanvas.width,prizeCanvas.height);
      prizeCtx.save();
      prizeCtx.translate(prizeCanvas.width/2, prizeCanvas.height/2);
      prizeCtx.rotate(angle);
      prizeCtx.beginPath();
      prizeCtx.lineWidth = stroke;
      prizeCtx.lineCap = "round";
      prizeCtx.strokeStyle = "#ffffff";
      prizeCtx.arc(0, 0, radius, 0, Math.PI * 1.6);
      prizeCtx.stroke();
      prizeCtx.restore();
      spinRAF = requestAnimationFrame(renderSpinner);
    }
    function startSpinner(){ stopSpinner(); spinStart=null; spinRAF=requestAnimationFrame(renderSpinner); }
    function stopSpinner(){ if(spinRAF) cancelAnimationFrame(spinRAF); spinRAF=null; prizeCtx.clearRect(0,0,prizeCanvas.width,prizeCanvas.height); }

    // ---------- Scratch cover (paint after message) ----------
    const BRUSH = 50;
    let isDrawing=false, userScratched=false, apiReady=false, isWinner=false, winnerCode="";
    let revealed=false;

    function paintCover() {
      scratchCtx.globalCompositeOperation = "source-over";
      const g = scratchCtx.createLinearGradient(0,0,0,scratchCanvas.height);
      g.addColorStop(0,"#a3a3a3");
      g.addColorStop(1,"#8d8d8d");
      scratchCtx.fillStyle = g;
      scratchCtx.clearRect(0,0,scratchCanvas.width, scratchCanvas.height);
      scratchCtx.fillRect(0,0,scratchCanvas.width, scratchCanvas.height);

      // very light noise
      try {
        const {width:w,height:h} = scratchCanvas;
        const noise = scratchCtx.createImageData(w, h);
        for (let i=0; i<noise.data.length; i+=16){
          const n = 215 + (Math.random()*35|0);
          noise.data[i]=n; noise.data[i+1]=n; noise.data[i+2]=n; noise.data[i+3]=18;
        }
        scratchCtx.putImageData(noise,0,0);
      } catch(_) {}

      scratchCtx.globalCompositeOperation = "destination-out";
    }

    function scratchAt(x,y){
      scratchCtx.beginPath();
      scratchCtx.arc(x,y,BRUSH,0,Math.PI*2);
      scratchCtx.fill();
      if (!revealed) maybeAutoReveal();
    }

    function startOnce(){
      if (!userScratched) {
        userScratched = true;
        wrapper.classList.remove("active-glow"); void wrapper.offsetWidth; wrapper.classList.add("active-glow");
        if (apiReady && isWinner) celebrate();
      }
    }

    // smoother input (pointer events)
    scratchCanvas.addEventListener('pointerdown', (e)=>{ isDrawing=true; startOnce(); drawPoints(e); });
    scratchCanvas.addEventListener('pointermove', (e)=>{ if(!isDrawing) return; drawPoints(e); });
    scratchCanvas.addEventListener('pointerup',   ()=>{ isDrawing=false; });
    scratchCanvas.addEventListener('pointerleave',()=>{ isDrawing=false; });
    function drawPoints(e){
      const r = scratchCanvas.getBoundingClientRect();
      const pts = e.getCoalescedEvents ? e.getCoalescedEvents() : [e];
      for (const p of pts){
        scratchAt(p.clientX - r.left, p.clientY - r.top);
      }
    }

    // auto-reveal when ~40% cleared
    function maybeAutoReveal(){
      const step = 8;
      const img = scratchCtx.getImageData(0,0,scratchCanvas.width,scratchCanvas.height).data;
      let clear = 0, total = 0;
      for (let i=3; i<img.length; i+=4*step){ total++; if (img[i] === 0) clear++; }
      const ratio = clear / total;
      if (ratio >= 0.40) {
        revealed = true;
        scratchCanvas.style.transition = 'opacity 220ms ease';
        scratchCanvas.style.opacity = '0';
        setTimeout(()=>{
          scratchCtx.clearRect(0,0,scratchCanvas.width,scratchCanvas.height);
          scratchCanvas.style.opacity = '';
          scratchCanvas.style.transition = '';
        }, 240);
        if (apiReady && isWinner) celebrate();
      }
    }

    // Copy
    copyBtn.addEventListener("click", ()=> {
      if(!winnerCode) return;
      navigator.clipboard.writeText(winnerCode).then(()=>{
        copyBtn.textContent = "Copied!";
        setTimeout(()=>copyBtn.textContent="Copy Code",1500);
      }).catch(()=>{
        copyBtn.textContent = "Copy failed";
        setTimeout(()=>copyBtn.textContent="Copy Code",1500);
      });
    });

    // ---------- Boot ----------
    startSpinner(); // draw spinner immediately

    const params = new URLSearchParams(location.search);
    const token  = (params.get('token') || '').trim();

    function showStatus(kind){
      const map = {
        token_used:    "‚ö†Ô∏è This link was already used.",
        token_expired: "‚ö†Ô∏è This link has expired.",
        token_invalid: "‚ö†Ô∏è Invalid link.",
        token_missing: "‚ö†Ô∏è Invalid link.",
        empty:         "‚ö†Ô∏è No codes available.",
        unauthorized:  "‚ö†Ô∏è Unauthorized request.",
        network:       "‚ö†Ô∏è Network error.",
        default:       "‚ö†Ô∏è Error fetching code."
      };
      drawCenteredText(prizeCtx, map[kind] || map.default);
    }

    if (!token) {
      stopSpinner();
      showStatus('token_missing');
    } else {
      fetch(apiUrl, {
        method: "POST",
        headers: { "Content-Type": "text/plain" }, // simple request (no preflight)
        body: JSON.stringify({ mode:"draw", token, apiKey: API_KEY })
      })
      .then(async r => {
        const ct = r.headers.get("content-type") || "";
        const data = ct.includes("application/json") ? await r.json() : { ok:false, error: await r.text() };
        stopSpinner();

        if (data.ok && data.status === 'ok' && data.mode === 'draw') {
          isWinner   = !!data.isWinner;
          winnerCode = data.code;
          drawCenteredText(prizeCtx, isWinner ? `üéâ You WON! Code: ${winnerCode}` : "üôÅ Better luck next time!", isWinner);
          apiReady = true;
          paintCover(); // hide with scratch cover
        } else if (data.status === 'token_used') {
          showStatus('token_used'); paintCover(); apiReady = true;
        } else if (data.status === 'token_expired') {
          showStatus('token_expired'); paintCover(); apiReady = true;
        } else if (data.status === 'empty') {
          showStatus('empty'); apiReady = true;
        } else if (data.status === 'token_invalid' || data.status === 'token_missing') {
          showStatus('token_invalid'); apiReady = true;
        } else if (data.error === 'Unauthorized') {
          showStatus('unauthorized'); apiReady = true;
        } else {
          console.error("API error:", data);
          showStatus('default'); apiReady = true;
        }
      })
      .catch(err => {
        console.error("Fetch error:", err);
        stopSpinner();
        showStatus('network'); apiReady = true;
      });
    }
  </script>
</body>
</html>
