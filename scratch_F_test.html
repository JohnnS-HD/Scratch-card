<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Scratch & Win</title>
  <style>
    :root { --bg:#171e31; --card:#1f2643; --ink:#fff; --muted:#ccc; --btn:#494f66; --focus:#7a86ff; }
    * { box-sizing: border-box; }
    body { background-color: var(--bg); font-family: Arial, sans-serif; text-align: center; color: var(--ink); margin: 0; padding: 0 12px 40px; overflow-x: hidden; }
    .logo { margin-top: 40px; margin-bottom: 20px; display: inline-block; }
    .container { background-color: var(--card); padding: 30px; margin: 0 auto 20px; max-width: 420px; border-radius: 12px; box-shadow: 0 10px 24px rgba(0,0,0,0.35); animation: fadeInUp 420ms ease both; }
    @keyframes fadeInUp { from {opacity:0; transform:translateY(8px);} to {opacity:1; transform:translateY(0);} }
    h2 { margin: 0 0 12px; font-weight: 700; letter-spacing: 0.2px; }
    .scratch-wrapper { position: relative; width: 360px; height: 100px; margin: 20px auto 0; border: 2px dashed #444; background-color: var(--card); border-radius: 10px; overflow: hidden; transition: box-shadow 300ms ease, transform 300ms ease; }
    .active-glow { animation: activePulse 900ms ease-out 1; }
    @keyframes activePulse { 0% { box-shadow: 0 0 0 0 rgba(255,255,255,0.0); } 40%{ box-shadow: 0 0 18px 6px rgba(255,255,255,0.15); } 100%{ box-shadow: 0 0 0 0 rgba(255,255,255,0); } }
    .win-glow { animation: winPulse 1200ms ease-out 2; }
    @keyframes winPulse { 0% { box-shadow: 0 0 0 0 rgba(255,215,107,0.6); transform: translateY(0) scale(1); } 40%{ box-shadow: 0 0 25px 8px rgba(255,215,107,0.5); transform: translateY(-2px) scale(1.02); } 100%{ box-shadow: 0 0 0 0 rgba(255,215,107,0); transform: translateY(0) scale(1); } }
    canvas { position: absolute; top: 0; left: 0; display:block; }
    #prizeCanvas { z-index: 1; } #scratchCanvas { z-index: 2; cursor: crosshair; }
    #copyRow { display:none; margin:10px auto 0; max-width:420px; }
    .btn { margin: 10px; padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; background: var(--btn); color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.25); transform: translateZ(0); transition: transform 160ms ease, box-shadow 160ms ease, filter 160ms ease; }
    .btn:hover { transform: translateY(-2px) scale(1.03); box-shadow: 0 8px 18px rgba(0,0,0,0.35); filter: brightness(1.05); }
    .btn-small { padding: 6px 12px; font-size: 14px; }
    .instructions-box { background-color: #192036; text-align: left; padding: 15px; margin-top: 30px; font-size: 14px; line-height: 1.4; color: var(--muted); border-radius: 8px; }
    .instructions-box a { color: var(--muted); text-decoration: underline; }
    .socials-wrap { margin:22px auto 0; max-width:560px; }
    .socials { display:flex; justify-content:center; gap:24px; flex-wrap:wrap; }
    .socials a img { width:60px; height:auto; object-fit:contain; display:block; }
    .socials a img[src*="discord"] { transform: scale(1.25); }
    @media (prefers-reduced-motion: reduce) { .btn { transition: none; } .active-glow, .win-glow { animation: none; } }
    .confetti { position:absolute; inset:0; pointer-events:none; z-index:3; }
    .confetti span { position:absolute; width:6px; height:10px; opacity:.9; animation:drop 900ms ease-out forwards; }
    @keyframes drop { 0%{transform:translateY(-20px) rotate(0)} 100%{transform:translateY(140px) rotate(360deg);opacity:0} }
  </style>
</head>
<body>
  <a href="https://www.hypedrop.com/" target="_blank" rel="noopener">
    <img src="Logo-Full-White.png" alt="Logo" class="logo" width="360"/>
  </a>

  <div class="container">
    <h2>Scratch here and get your prize</h2>

    <div class="scratch-wrapper" id="scratchWrapper">
      <canvas id="prizeCanvas" width="360" height="100"></canvas>
      <canvas id="scratchCanvas" width="360" height="100"></canvas>
      <div class="confetti" id="confetti"></div>
    </div>

    <div id="copyRow">
      <button id="copyBtn" class="btn btn-small" type="button">Copy Code</button>
    </div>

    <div class="instructions-box">
      <strong>How to redeem:</strong><br>
      Visit the Rewards page<br>
      Enter your code in “Do you have a promo code?”<br>
      Click Apply<br>
      Need help? <a href="https://www.hypedrop.com/support" target="_blank" rel="noopener">Support team</a> is ready to help you!
    </div>

    <div style="margin-top: 20px;">
      <button class="btn" onclick="window.location.href='https://www.hypedrop.com/na/rewards'">Go to Rewards</button>
    </div>
  </div>

  <div class="socials-wrap">
    <div class="socials">
      <a href="https://discord.gg/yGrM3eCsqD" target="_blank" rel="noopener"><img src="Discord.png" alt="Discord"/></a>
      <a href="https://www.instagram.com/hypedropcom/" target="_blank" rel="noopener"><img src="instagram-new--v2.png" alt="Instagram"/></a>
      <a href="https://x.com/HypeDrop" target="_blank" rel="noopener"><img src="X_logo_2023_(white).png" alt="X"/></a>
    </div>
  </div>

  <script>
    // ---------- CONFIG ----------
    const apiUrl = "YOUR_APPS_SCRIPT_WEB_APP_URL_HERE";
    const API_KEY = "YOUR_TEMP_API_KEY_HERE"; // same value saved in Apps Script Script Properties

    // ---------- DOM ----------
    const wrapper       = document.getElementById("scratchWrapper");
    const prizeCanvas   = document.getElementById("prizeCanvas");
    const prizeCtx      = prizeCanvas.getContext("2d");
    const scratchCanvas = document.getElementById("scratchCanvas");
    const scratchCtx    = scratchCanvas.getContext("2d");
    const confettiEl    = document.getElementById("confetti");
    const copyRow       = document.getElementById("copyRow");
    const copyBtn       = document.getElementById("copyBtn");

    function drawCenteredText(ctx, text, bold=false) {
      ctx.clearRect(0,0,ctx.canvas.width, ctx.canvas.height);
      ctx.font = `${bold ? '700' : '400'} 18px Arial, sans-serif`;
      ctx.fillStyle = "#fff";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(text, ctx.canvas.width/2, ctx.canvas.height/2);
    }

    function fireConfetti() {
      confettiEl.innerHTML = "";
      const colors = ["#ffd76b", "#7a86ff", "#ff8ba7", "#7fffd4", "#ffffff"];
      for (let i=0;i<70;i++){
        const s = document.createElement("span");
        s.style.left = Math.random()*100 + "%";
        s.style.top  = "-10px";
        s.style.background = colors[Math.floor(Math.random()*colors.length)];
        s.style.animationDelay = (Math.random()*0.25) + "s";
        s.style.transform = `rotate(${Math.random()*360}deg)`;
        confettiEl.appendChild(s);
      }
      setTimeout(()=>confettiEl.innerHTML="",1300);
    }

    function celebrate() {
      wrapper.classList.remove("win-glow");
      void wrapper.offsetWidth;
      wrapper.classList.add("win-glow");
      fireConfetti();
      copyRow.style.display = "block";
    }

    // Spinner
    let spinRAF = null, spinStart = null;
    function renderSpinner(ts) {
      if (!spinStart) spinStart = ts;
      const t = (ts - spinStart) / 1000, angle = t * 4 * Math.PI, radius = 14, stroke = 4;
      prizeCtx.clearRect(0,0,prizeCanvas.width,prizeCanvas.height);
      prizeCtx.save(); prizeCtx.translate(prizeCanvas.width/2, prizeCanvas.height/2); prizeCtx.rotate(angle);
      prizeCtx.beginPath(); prizeCtx.lineWidth = stroke; prizeCtx.lineCap = "round"; prizeCtx.strokeStyle = "#ffffff";
      prizeCtx.arc(0, 0, radius, 0, Math.PI * 1.6); prizeCtx.stroke(); prizeCtx.restore();
      spinRAF = requestAnimationFrame(renderSpinner);
    }
    function startSpinner(){ stopSpinner(); spinStart=null; spinRAF=requestAnimationFrame(renderSpinner); }
    function stopSpinner(){ if(spinRAF) cancelAnimationFrame(spinRAF); spinRAF=null; prizeCtx.clearRect(0,0,prizeCanvas.width,prizeCanvas.height); }

    // Scratch layer
    scratchCtx.globalCompositeOperation = "source-over";
    scratchCtx.fillStyle = "#999";
    scratchCtx.fillRect(0,0,scratchCanvas.width, scratchCanvas.height);
    scratchCtx.globalCompositeOperation = "destination-out";

    const BRUSH = 50;
    let isDrawing=false, userScratched=false, apiReady=false, isWinner=false, winnerCode="";

    function scratchAt(x,y){ scratchCtx.beginPath(); scratchCtx.arc(x,y,BRUSH,0,Math.PI*2); scratchCtx.fill(); }
    function startOnce(){
      if (!userScratched) {
        userScratched = true;
        wrapper.classList.remove("active-glow"); void wrapper.offsetWidth; wrapper.classList.add("active-glow");
        if (apiReady && isWinner) celebrate();
      }
    }

    // Mouse
    scratchCanvas.addEventListener("mousedown",(e)=>{ isDrawing=true; startOnce(); const r=scratchCanvas.getBoundingClientRect(); scratchAt(e.clientX-r.left,e.clientY-r.top); });
    scratchCanvas.addEventListener("mouseup",()=>isDrawing=false);
    scratchCanvas.addEventListener("mouseleave",()=>isDrawing=false);
    scratchCanvas.addEventListener("mousemove",(e)=>{ if(!isDrawing) return; const r=scratchCanvas.getBoundingClientRect(); scratchAt(e.clientX-r.left,e.clientY-r.top); });
    // Touch
    scratchCanvas.addEventListener("touchstart",(e)=>{ e.preventDefault(); isDrawing=true; startOnce(); const r=scratchCanvas.getBoundingClientRect(); const t=e.touches[0]; scratchAt(t.clientX-r.left,t.clientY-r.top); }, {passive:false});
    scratchCanvas.addEventListener("touchend",()=>{ isDrawing=false; }, {passive:true});
    scratchCanvas.addEventListener("touchmove",(e)=>{ e.preventDefault(); if(!isDrawing) return; const r=scratchCanvas.getBoundingClientRect(); const t=e.touches[0]; scratchAt(t.clientX-r.left,t.clientY-r.top); }, {passive:false});

    copyBtn.addEventListener("click", ()=>{ if(!winnerCode) return; navigator.clipboard.writeText(winnerCode).then(()=>{ copyBtn.textContent="Copied!"; setTimeout(()=>copyBtn.textContent="Copy Code",1500); }).catch(()=>{ copyBtn.textContent="Copy failed"; setTimeout(()=>copyBtn.textContent="Copy Code",1500); }); });

    // Start
    startSpinner();
    const params = new URLSearchParams(location.search);
    const token  = (params.get('token') || '').trim();

    if (!token) {
      stopSpinner();
      drawCenteredText(prizeCtx, "⚠️ Invalid link.", false);
    } else {
      fetch(apiUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json", "x-api-key": API_KEY },
        body: JSON.stringify({ mode: "draw", token })
      })
      .then(r => r.json())
      .then(data => {
        stopSpinner();
        if (data.status === 'ok' && data.mode === 'draw') {
          isWinner  = !!data.isWinner;
          winnerCode = data.code;
          drawCenteredText(prizeCtx, isWinner ? `🎉 You WON! Code: ${winnerCode}` : "🙁 Better luck next time!", isWinner);
          apiReady = true;
          if (userScratched && isWinner) celebrate();
        } else if (data.status === 'token_used')      { drawCenteredText(prizeCtx, "⚠️ This link was already used.", false); apiReady=true; }
          else if (data.status === 'token_expired')   { drawCenteredText(prizeCtx, "⚠️ This link has expired.", false); apiReady=true; }
          else if (data.status === 'empty')           { drawCenteredText(prizeCtx, "⚠️ No codes available.", false); apiReady=true; }
          else if (data.status === 'token_invalid' || data.status === 'token_missing') {
                                                       drawCenteredText(prizeCtx, "⚠️ Invalid link.", false); apiReady=true;
        } else {
          drawCenteredText(prizeCtx, "⚠️ Error fetching code.", false); apiReady=true;
        }
      })
      .catch(()=>{ stopSpinner(); drawCenteredText(prizeCtx, "⚠️ Network error.", false); apiReady=true; });
    }
  </script>
</body>
</html>
