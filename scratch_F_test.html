<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Scratch & Win</title>
<style>
  :root { --bg:#171e31; --card:#1f2643; --ink:#fff; --muted:#ccc; --btn:#494f66; }
  *{box-sizing:border-box} body{background:var(--bg);color:var(--ink);font-family:Arial;margin:0;padding:24px;text-align:center}
  .container{background:var(--card);max-width:420px;margin:0 auto;padding:24px;border-radius:12px}
  .scratch{position:relative;width:360px;height:100px;margin:16px auto;border:2px dashed #444;border-radius:10px;overflow:hidden}
  canvas{position:absolute;top:0;left:0;display:block}
  #prize{z-index:1} #cover{z-index:2;cursor:crosshair}
  #copyRow{display:none;margin-top:8px}
  .btn{background:var(--btn);color:#fff;border:0;border-radius:8px;padding:10px 16px;cursor:pointer}
</style>
</head>
<body>
  <div class="container">
    <h2>Scratch here and get your prize</h2>

    <div class="scratch" id="wrap">
      <canvas id="prize" width="360" height="100"></canvas>
      <canvas id="cover" width="360" height="100"></canvas>
    </div>

    <div id="copyRow"><button id="copyBtn" class="btn" type="button">Copy Code</button></div>
    <div><button class="btn" onclick="location.href='https://www.hypedrop.com/na/rewards'">Go to Rewards</button></div>
  </div>

<script>
/* ===== CONFIG (set your values) ===== */
const API_URL = "https://script.google.com/macros/s/AKfycbwwzCiQTUppQN7xsuFnsEWE46kZD4vVMuHrOqIIZQEW0dESsXmiqcPeVliYDrjsuB3BdQ/exec";
const API_KEY = "2f9a0d8b1e7c4f1b98d2a6e4c5f0b7a8d1e9f3c6a2b8e7f9d0c1a5b4e6d2f0a9"; // EXACTLY the same as Script Properties
/* =================================== */

const prize = document.getElementById('prize');
const pctx  = prize.getContext('2d');
const cover = document.getElementById('cover');
const cctx  = cover.getContext('2d');
const copyRow = document.getElementById('copyRow');
const copyBtn = document.getElementById('copyBtn');

let isWinner=false, winnerCode="", userScratched=false;

/* ‚Äî‚Äî‚Äî debug helper: show any error on the canvas ‚Äî‚Äî‚Äî */
function show(msg){
  try{
    pctx.clearRect(0,0,prize.width,prize.height);
    pctx.font='400 16px Arial'; pctx.fillStyle='#fff';
    pctx.textAlign='center'; pctx.textBaseline='middle';
    pctx.fillText(String(msg).slice(0,260), prize.width/2, prize.height/2);
  }catch(e){}
}
window.addEventListener('error', e=>show('JS error: ' + (e.error?.message||e.message)));
window.addEventListener('unhandledrejection', e=>show('Promise error: ' + (e.reason?.message||e.reason)));

/* spinner */
let raf=null, t0=null;
function spin(ts){
  if(!t0) t0=ts;
  const t=(ts-t0)/1000, angle=t*4*Math.PI, R=14, W=4;
  pctx.clearRect(0,0,prize.width,prize.height);
  pctx.save(); pctx.translate(prize.width/2, prize.height/2); pctx.rotate(angle);
  pctx.beginPath(); pctx.lineWidth=W; pctx.lineCap='round'; pctx.strokeStyle='#fff';
  pctx.arc(0,0,R,0,Math.PI*1.6); pctx.stroke(); pctx.restore();
  raf=requestAnimationFrame(spin);
}
function startSpin(){ if(raf) cancelAnimationFrame(raf); t0=null; raf=requestAnimationFrame(spin); }
function stopSpin(){ if(raf) cancelAnimationFrame(raf); raf=null; pctx.clearRect(0,0,prize.width,prize.height); }

/* enable scratch AFTER message is drawn */
function enableScratch(){
  cctx.globalCompositeOperation='source-over';
  cctx.fillStyle='#999';
  cctx.clearRect(0,0,cover.width,cover.height);
  cctx.fillRect(0,0,cover.width,cover.height);
  cctx.globalCompositeOperation='destination-out';
  const BRUSH=50; let drawing=false;

  function scratchAt(x,y){ cctx.beginPath(); cctx.arc(x,y,BRUSH,0,Math.PI*2); cctx.fill(); }
  function startOnce(){ if(!userScratched){ userScratched=true; if(isWinner) { copyRow.style.display='block'; } } }

  cover.addEventListener('mousedown',e=>{drawing=true;startOnce(); const r=cover.getBoundingClientRect(); scratchAt(e.clientX-r.left,e.clientY-r.top);});
  cover.addEventListener('mouseup',()=>drawing=false);
  cover.addEventListener('mouseleave',()=>drawing=false);
  cover.addEventListener('mousemove',e=>{ if(!drawing) return; const r=cover.getBoundingClientRect(); scratchAt(e.clientX-r.left,e.clientY-r.top); });

  cover.addEventListener('touchstart',e=>{ e.preventDefault(); drawing=true; startOnce(); const r=cover.getBoundingClientRect(); const t=e.touches[0]; scratchAt(t.clientX-r.left,t.clientY-r.top); }, {passive:false});
  cover.addEventListener('touchend',()=>{ drawing=false; }, {passive:true});
  cover.addEventListener('touchmove',e=>{ e.preventDefault(); if(!drawing) return; const r=cover.getBoundingClientRect(); const t=e.touches[0]; scratchAt(t.clientX-r.left,t.clientY-r.top); }, {passive:false});
}

/* copy */
copyBtn.addEventListener('click', ()=>{ if(!winnerCode) return; navigator.clipboard.writeText(winnerCode).then(()=>{ copyBtn.textContent='Copied!'; setTimeout(()=>copyBtn.textContent='Copy Code',1200); });});

/* boot */
(function init(){
  show('Loading‚Ä¶'); // visible text while spinner starts
  startSpin();

  const token = (new URLSearchParams(location.search).get('token')||'').trim();
  if(!token){ stopSpin(); show('‚ö†Ô∏è Invalid link (missing token).'); return; }

  fetch(API_URL, {
    method:'POST',
    headers:{ 'Content-Type':'text/plain' }, // simple request (no preflight)
    body: JSON.stringify({ mode:'draw', token, apiKey: API_KEY })
  })
  .then(async r=>{
    const ct=r.headers.get('content-type')||'';
    const data = ct.includes('application/json') ? await r.json() : { ok:false, error:(await r.text()) };
    stopSpin();

    if(data.ok && data.status==='ok' && data.mode==='draw'){
      isWinner = !!data.isWinner;
      winnerCode = data.code;
      show(isWinner ? `üéâ You WON! Code: ${winnerCode}` : 'üôÅ Better luck next time!');
      enableScratch();
    } else if (data.status==='token_used')    { show('‚ö†Ô∏è This link was already used.'); enableScratch(); }
      else if (data.status==='token_expired') { show('‚ö†Ô∏è This link has expired.'); enableScratch(); }
      else if (data.status==='empty')         { show('‚ö†Ô∏è No codes available.'); }
      else if (data.status==='token_invalid' || data.status==='token_missing') { show('‚ö†Ô∏è Invalid link.'); }
      else { show('‚ö†Ô∏è Error: ' + (data.error||'unexpected')); console.error('API:',data); }
  })
  .catch(err=>{ stopSpin(); show('‚ö†Ô∏è Network error: '+(err.message||err)); console.error(err); });
})();
</script>
</body>
</html>
